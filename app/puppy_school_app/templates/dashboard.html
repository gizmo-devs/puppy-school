{% extends 'layout/base.html' %}

{% block title %}Dashboard{% endblock %}
{%block content%}

<div class="container-fluid">
    <h1 class="mt-4">Dashboard</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">Dashboard</li>
    </ol>
    <div class="row">
        {% set cards = [
            ('Loo Break', 'last_loo_break', 'scheduled_loo', 'fa-poop', 'loo.index', 'time'),
            ('Weighed','last_weighed', 'scheduled_weigh', 'fa-balance-scale', 'weight.index', 'date')
        ]%}
        {# ('Fed', 'last_fed', '', ''), #}
        {% for title, element_name, element_name_next, icon, link, show in cards%}
        <div class="col-xl-3 col-md-6">
            <div class="card mb-4">
                <h5 class="card-header"><i class="fas {{icon}}"></i> Last {{title}}</h5>
                <ul class="list-group list-group-flush">
                    {% for dog in session['dogs'] %}
                        <li class="list-group-item">
                            <div class="row">
                            <div class="col-4"><strong>{{dog.name}}</strong></div>
                            {% if (element_name_next != None) and (dog[element_name_next] != None) and (dog[element_name_next] is defined) and (dog[element_name] != None) %}
                                {% if show == 'time' %}
                                    <div class="col-4">
                                            {{ dog[element_name].strftime('%H:%M') }}
                                    </div>
                                    <div class="col-4">
                                        <span class="dt" data-ts="{{dog[element_name_next]}}">
                                            {{ dog[element_name_next].strftime('%H:%M') }}
                                        </span></div>
                                {% elif show == 'date' %}
                                    <div class="col-4">{{ dog[element_name].strftime('%d %b') }}</div>
                                    <div class="col-4 ">
                                        <span class="dt" data-ts="{{dog[element_name_next]}}">
                                            {{ dog[element_name_next].strftime('%d %b') }}
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                            {% else %}
                                -
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small stretched-link" href="{{url_for(link)}}">View Details</a>
                    <div class="small"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="row">
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header"><i class="fas fa-chart-area mr-1"></i>Weight Gain</div>
                <div class="card-body">
                    <canvas id="myAreaChart" width="100%" height="40"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header"><i class="fas fa-chart-bar mr-1"></i>Bar Chart Example</div>
                <div class="card-body">
                    <canvas id="myBarChart" width="100%" height="40"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
{% for dog in session.dogs %}
    $.get("{{url_for('weight.get_dogs_weights', dog_id=dog.id)}}",
        function(r){
            process_response(r)
        }
    );
{% endfor %}

function process_response(data){
    console.log(data)
    var keys = []
    var vals = []
    $.each(data, function(key, val){
        keys.push(moment(this.date_measured).format("D MMM"));
        vals.push(this.weight);
    });
    console.log("Keys:", keys, "Values:", vals)
    render_chart('myAreaChart', keys, vals)
}

function render_chart(elem, keys, values) {
    var ctx = document.getElementById(elem);
    var myLineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels:
            keys
        ,
        datasets: [{
          label: "tiggy",
          lineTension: 0.3,
          backgroundColor: "rgba(2,117,216,0.2)",
          borderColor: "rgba(2,117,216,1)",
          pointRadius: 5,
          pointBackgroundColor: "rgba(2,117,216,1)",
          pointBorderColor: "rgba(255,255,255,0.8)",
          pointHoverRadius: 5,
          pointHoverBackgroundColor: "rgba(2,117,216,1)",
          pointHitRadius: 50,
          pointBorderWidth: 2,
          data:
            values
          ,
        }],
      },
      options: {
        scales: {
          xAxes: [{
            time: {
              unit: 'date'
            },
            gridLines: {
              display: false
            },
            ticks: {
              maxTicksLimit: 7
            }
          }],
          yAxes: [{
            ticks: {
              min: 0,
              //max: 40000,
              maxTicksLimit: 5
            },
            gridLines: {
              color: "rgba(0, 0, 0, .125)",
            }
          }],
        },
        legend: {
          display: false
        }
      }
    });
}

{% for dog in dog_data %}

{% endfor %}
</script>
{%endblock%}